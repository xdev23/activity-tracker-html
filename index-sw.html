<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Activity Tracker</title>
    <style>
        :root {
            --border-color-light: #d0d7de; --bg-color-light: #f6f8fa; --card-bg-color-light: #ffffff; --text-color-light: #24292e; --text-muted-color-light: #57606a;
            --border-color-dark: #30363d; --bg-color-dark: #0d1117; --card-bg-color-dark: #161b22; --text-color-dark: #c9d1d9; --text-muted-color-dark: #8b949e;
            
            --border-color: var(--border-color-light); --bg-color: var(--bg-color-light); --card-bg-color: var(--card-bg-color-light); --text-color: var(--text-color-light); --text-muted-color: var(--text-muted-color-light);
            
            --day-size: 14px; --day-gap: 4px; --week-width: calc(var(--day-size) + var(--day-gap));
            --day-bg-default: #ebedf0; --day-bg-alt-month: #f6f8fa;
            --level-1: #9be9a8; --level-2: #40c463; --level-3: #30a14e; --level-4: #216e39;

            --btn-bg-color: #f6f8fa;
            --btn-hover-bg-color: #e1e4e8;
        }
        body.dark-mode {
            --border-color: var(--border-color-dark); --bg-color: var(--bg-color-dark); --card-bg-color: var(--card-bg-color-dark); --text-color: var(--text-color-dark); --text-muted-color: var(--text-muted-color-dark);
            --day-bg-default: #2a3038; --day-bg-alt-month: #22272e;
            --level-1: #0e4429; --level-2: #006d32; --level-3: #26a641; --level-4: #39d353;
            
            --btn-bg-color: #21262d;
            --btn-hover-bg-color: #30363d;
        }

        body.dark-mode {
            scrollbar-color: #58a6ff #161b22;
        }
        body.dark-mode::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        body.dark-mode::-webkit-scrollbar-track {
            background: var(--card-bg-color-dark);
        }
        body.dark-mode::-webkit-scrollbar-thumb {
            background-color: #30363d;
            border-radius: 6px;
            border: 3px solid var(--card-bg-color-dark);
        }
        body.dark-mode::-webkit-scrollbar-thumb:hover {
            background-color: #57606a;
        }


        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px; transition: background-color 0.3s, color 0.3s; }
        .main-container { max-width: 1050px; margin: auto; display: flex; flex-direction: column; gap: 20px; }
        .card { border: 1px solid var(--border-color); border-radius: 6px; padding: 16px; background-color: var(--card-bg-color); transition: background-color 0.3s, border-color 0.3s; }
        h1, h2, h3 { color: var(--text-color); margin-top: 0; margin-bottom: 16px; transition: color 0.3s; }
        h1 { display: flex; justify-content: space-between; align-items: center; }
        .header-buttons { display: flex; gap: 10px; }
        h2 { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .activity-title-group { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; }
        .activity-title-group .goal-display { font-size: 0.7em; font-weight: 400; color: var(--text-muted-color); }
        .timer-display-group { display: flex; align-items: center; gap: 8px; }
        .time-display { font-size: 0.8em; font-weight: 400; color: var(--text-muted-color); background-color: var(--bg-color); padding: 4px 8px; border-radius: 4px; transition: background-color 0.3s; order: 2; }
        .controls { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
        .input-group { display: flex; flex-direction: column; flex-grow: 1; }
        .input-group label { font-size: 12px; color: var(--text-muted-color); margin-bottom: 4px; }
        .input-group input { padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--card-bg-color); color: var(--text-color); }
        #activity-goal-input { width: 80px; }
        
        .btn { padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--btn-bg-color); color: var(--text-color); cursor: pointer; font-weight: 500; white-space: nowrap; transition: background-color 0.2s; }
        .btn:hover { background-color: var(--btn-hover-bg-color); }

        .year-nav { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; padding-top: 15px; }
        .year-btn { font-size: 12px; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--btn-bg-color); color: var(--text-muted-color); cursor: pointer; transition: background-color 0.2s; }
        .year-btn:hover { background-color: var(--btn-hover-bg-color); }
        .year-btn.active { background-color: #0969da; color: white; border-color: #0969da; }
        
        .tagline {
            font-size: 0.9em;
            color: var(--text-muted-color);
            margin-top: -12px;
            margin-bottom: 20px;
            font-weight: 400;
        }

        .graph-container::after { content: ""; display: table; clear: both; }
        .graph-scroll-wrapper { overflow-x: auto; padding-top: 10px; }
        .graph-content { display: inline-grid; grid-template-areas: "y-axis months" "y-axis grid"; grid-template-columns: auto 1fr; grid-template-rows: auto 1fr; gap: 8px; }
        .day-labels { 
            grid-area: y-axis; 
            display: grid; 
            grid-template-rows: repeat(7, var(--day-size)); 
            grid-row-gap: var(--day-gap); 
            font-size: 12px; 
            color: var(--text-muted-color); 
            padding-top: 5px; 
            position: sticky;
            left: 0;
            z-index: 1;
            background-color: var(--card-bg-color);
            padding-right: 10px;
            padding-top: 22px;
            padding-bottom: 20px;
        }
        .day-labels span { display: block; height: var(--day-size); line-height: var(--day-size); }
        .month-labels { grid-area: months; display: grid; grid-auto-flow: column; gap: var(--day-gap); font-size: 12px; color: var(--text-muted-color); }
        .month-label { text-align: left; }
        .tracker-grid { grid-area: grid; display: grid; grid-auto-flow: column; grid-template-rows: repeat(7, var(--day-size)); gap: var(--day-gap); }
        .day { position: relative; width: var(--day-size); height: var(--day-size); background-color: var(--day-bg-default); border-radius: 2px; box-sizing: border-box; }
        .day.alt-month { background-color: var(--day-bg-alt-month); }
        .day.is-creation-date { outline: 2px solid #0969da; }
        .day.is-today { outline: 2px solid #d10f0f; }
        .day.is-today.is-creation-date { outline: 2px solid #d400ff; }
        .color-level-1 { background-color: var(--level-1) !important; } .color-level-2 { background-color: var(--level-2) !important; } .color-level-3 { background-color: var(--level-3) !important; } .color-level-4 { background-color: var(--level-4) !important; }

        .day.goal-completed::after {
            content: '';
            position: absolute;
            box-sizing: border-box;
            left: 50%;
            top: 45%;
            width: calc(var(--day-size) * 0.35);
            height: calc(var(--day-size) * 0.65);
            border-style: solid;
            border-color: white;
            border-width: 0 calc(var(--day-size) / 7) calc(var(--day-size) / 7) 0;
            transform: translate(-50%, -50%) rotate(45deg);
            opacity: 0.9;
        }
        .graph-legend {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-muted-color);
            margin-top: 5px;
            float: right;
        }
        .graph-legend .day { border: 1px solid rgba(0,0,0,0.1); }
        body.dark-mode .graph-legend .day { border: 1px solid rgba(255,255,255,0.1); }
        
        .legend-item-wrapper {
            position: relative;
            display: flex;
        }
        .legend-overlay {
            display: none;
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #24292e;
            color: #ffffff;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
            pointer-events: none;
        }
        .legend-overlay::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #24292e transparent transparent transparent;
        }
        .legend-item-wrapper:hover .legend-overlay {
            display: block;
        }
        
        .activity-controls { display: flex; align-items: center; flex-wrap: wrap; gap: 5px; }
        .timer-btn { padding: 5px 10px; border-radius: 4px; border: 1px solid var(--border-color); cursor: pointer; background-color: var(--btn-bg-color); color: var(--text-color); transition: background-color 0.2s, color 0.2s; font-size: 12px; }
        .timer-btn:hover { background-color: var(--btn-hover-bg-color); }
        .edit-name-btn, .edit-goal-btn { border-color: var(--text-muted-color); color: var(--text-muted-color); }
        .archive-btn { border-color: #a37100; color: #a37100; }
        .delete-btn { border-color: #8b0000; color: #8b0000; }
        .unarchive-btn { border-color: #28a745; color: #28a745; }
        .toggle-timer-btn.is-stopped { border-color: #28a745; color: #28a745; order: 1; }
        .toggle-timer-btn.is-running { border-color: #dc3545; color: #dc3545; background-color: rgba(220, 53, 69, 0.1); order: 1; }
        .toggle-timer-btn.is-running:hover { background-color: rgba(220, 53, 69, 0.2); }
        
        #tooltip { 
            position: fixed; 
            display: none; 
            background-color: #24292e; 
            color: #ffffff; 
            padding: 5px 10px; 
            border-radius: 6px; 
            font-size: 12px; 
            pointer-events: none; 
            z-index: 1000; 
            white-space: nowrap;
            transition: transform 0.1s ease-out;
        }
        .data-container { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 13px; }
        .stat-item strong { display: block; color: var(--text-color); }
        .stat-item span { color: var(--text-muted-color); }
        .historical-list { list-style: none; padding: 0; margin: 0; max-height: 220px; overflow-y: auto; }
        .historical-list li { padding: 8px 4px; font-size: 13px; color: var(--text-muted-color); display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; border-bottom: 1px solid var(--bg-color); }
        .historical-list .list-header { font-weight: bold; border-bottom: 1px solid var(--border-color); }
        .archived-activity-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid var(--bg-color); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-box { background: var(--card-bg-color); padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; text-align: center; }
        .modal-box .input-group { margin-bottom: 10px; text-align: left; }
        #modal-error-message { color: #dc3545; font-size: 13px; margin-top: 15px; display: none; }
        .modal-buttons { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }

        #reorder-list-container { margin-top: 15px; text-align: left; }
        .reorder-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 8px; }
        .reorder-controls { display: flex; gap: 5px; }
        .reorder-btn { background-color: var(--btn-bg-color); border: 1px solid var(--text-muted-color); color: var(--text-muted-color); border-radius: 4px; width: 28px; height: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        .reorder-btn:hover:not(:disabled) { background-color: var(--btn-hover-bg-color); }
        .reorder-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        #manage-activities-section {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        #manage-activities-section summary {
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 500;
            list-style-position: inside;
        }
        #manage-activities-section[open] > summary {
            border-bottom: 1px solid var(--border-color);
        }
        .collapsible-content-wrapper {
            padding: 16px;
        }
        .data-io {
            margin-top: 15px;
            border-top: 1px solid var(--border-color) !important;
            padding-top: 15px !important;
        }

        #sw-controls {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        #sw-status {
            font-size: 13px;
            color: var(--text-muted-color);
            flex-basis: 100%;
            margin: 0 0 5px 0;
        }

        @media (max-width: 600px) {
            :root {
                --day-size: 20px;
            }
            body {
                padding: 10px;
                -webkit-text-size-adjust: 100%;
            }
            .graph-legend {
                float: none;
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
            }

            h1 {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                font-size: 1.5em;
            }
            
            .header-buttons {
                width: 100%;
                justify-content: flex-start;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            #activity-goal-input {
                width: 100%;
                box-sizing: border-box;
            }

            .data-io {
                display: flex;
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .data-io .btn {
                 text-align: center;
            }

            h2 {
                flex-direction: column;
                align-items: flex-start;
            }

            .timer-display-group {
                width: 100%;
                justify-content: space-between;
                margin-top: 10px;
            }

            .historical-list .list-header {
                display: none;
            }

            .historical-list li {
                grid-template-columns: 1fr;
                gap: 6px;
                padding: 12px;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                margin-bottom: 8px;
            }
            
            .historical-list li span:nth-child(1)::before { content: 'Date: '; font-weight: bold; color: var(--text-color); }
            .historical-list li span:nth-child(2)::before { content: 'Time Spent: '; font-weight: bold; color: var(--text-color); }
            .historical-list li span:nth-child(3)::before { content: 'Daily Goal: '; font-weight: bold; color: var(--text-color); }
            .historical-list li span:nth-child(4)::before { content: 'Goal Achieved: '; font-weight: bold; color: var(--text-color); }

            .archived-activity-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .modal-box {
                width: 95%;
            }
        }
        
        .about-card {
            margin-top: 20px;
        }

        .about-card h4 {
            margin-bottom: 12px;
            font-size: 1.1em;
            color: var(--text-color);
        }
        
        .about-card h5 {
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .about-card p {
            font-size: 14px;
            color: var(--text-muted-color);
            line-height: 1.5;
            margin: 0;
        }

        .about-card ul {
            font-size: 14px;
            color: var(--text-muted-color);
            line-height: 1.5;
            padding-left: 20px;
            margin: 0;
        }

        .about-card li {
            margin-bottom: 6px;
        }

        .about-card li strong {
            color: var(--text-color);
        }
    </style>
</head>
<body class="light-mode">

    <div id="tooltip"></div>
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title">Confirm Action</h3>
            <p id="modal-message">Are you sure?</p>
            <div id="modal-inputs"></div>
            <p id="modal-error-message"></p>
            <div class="modal-buttons">
                <button data-action="modal-cancel" class="btn">Cancel</button>
                <button data-action="modal-confirm" class="btn">Confirm</button>
            </div>
        </div>
    </div>


    <div class="main-container">
        <div class="card">
            <h1>Activity Tracker
                <div class="header-buttons">
                    <button id="reorder-btn" data-action="reorder-activities" class="btn" style="font-size: 12px; display: none;">Reorder</button>
                    <button data-action="toggle-theme" class="btn" style="font-size: 12px;">Toggle Theme</button>
                </div>
            </h1>
            <p class="tagline">Your personal journey, one day at a time.</p>

            <details id="manage-activities-section">
                <summary>Manage Activities and Backup</summary>
                <div class="collapsible-content-wrapper">
                    <div class="controls">
                        <div class="input-group">
                            <label for="activity-name-input">Activity Name</label>
                            <input type="text" id="activity-name-input" placeholder="e.g., Learning a Language">
                        </div>
                         <div class="input-group">
                            <label for="activity-goal-input">Goal (minutes)</label>
                            <input type="number" id="activity-goal-input" value="15" min="1">
                        </div>
                        <button data-action="add-activity" class="btn">Add Activity</button>
                    </div>
                     <div class="data-io" style="margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                        <button data-action="export" class="btn">Export Data</button>
                        <label for="import-file" class="btn">Import Data</label>
                        <input type="file" id="import-file" accept=".json" style="display: none;">
                    </div>

                    <div id="sw-controls">
                        <p id="sw-status"></p>
                        <button id="sw-install-btn" class="btn">Enable Offline Mode</button>
                        <button id="sw-remove-btn" class="btn" style="display: none;">Disable Offline Mode</button>
                        <button id="sw-update-btn" class="btn" style="display: none;">Update Now</button>
                    </div>

                </div>
            </details>

        </div>
        <div id="activities-container"></div>
        <div id="archived-container" class="card" style="display: none;">
             <h3>Archived Activities</h3>
             <div id="archived-list"></div>
        </div>

        <div class="card about-card">
            <h4>About This Activity Tracker</h4>
            <p>This tool is a comprehensive, browser-based solution designed to help you monitor and build your habits. All your data is stored locally in your browser, ensuring your privacy and providing offline access without needing an account.</p>
            <h5>Key Features:</h5>
            <ul>
                <li><strong>Multiple Activities:</strong> Track as many activities as you like, each with its own history and goals.</li>
                <li><strong>Live Timer:</strong> Use the Start/Stop timer to automatically log time for an activity.</li>
                <li><strong>Manual Entry:</strong> Manually add or edit time for any past date, giving you full control over your log.</li>
                <li><strong>Interactive Graph:</strong> Visualize your consistency over the entire year. Hover (or tap on mobile) to see daily details.</li>
                <li><strong>Data Portability:</strong> Securely export your data to a JSON file for backup and import it back at any time.</li>
                <li><strong>Light & Dark Modes:</strong> Switch between themes for your viewing comfort.</li>
                 <li><strong>Offline Mode:</strong> Save the app for offline use, ensuring access even without an internet connection.</li>
            </ul>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Constants and State ---
        const MONTH_NAMES = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        let activities = {};
        let timers = {};
        let activityOrder = [];
        let modalConfirmCallback = () => {};
        
        const docBody = document.body;
        const activityNameInput = document.getElementById('activity-name-input');
        const activityGoalInput = document.getElementById('activity-goal-input');
        const activitiesContainer = document.getElementById('activities-container');
        const archivedContainer = document.getElementById('archived-container');
        const archivedList = document.getElementById('archived-list');
        const tooltip = document.getElementById('tooltip');
        const modal = document.getElementById('custom-modal');
        const reorderBtn = document.getElementById('reorder-btn');
        
        function getLocalDateString(dateObj) {
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function scrollToTodayForAllActivities() {
            const activityCards = document.querySelectorAll('.activity-card');
            activityCards.forEach(card => {
                const todayCell = card.querySelector('.day.is-today');
                const scrollWrapper = card.querySelector('.graph-scroll-wrapper');
                if (todayCell && scrollWrapper) {
                    const scrollLeftPosition = todayCell.offsetLeft - (scrollWrapper.offsetWidth / 2) + (todayCell.offsetWidth / 2);
                    scrollWrapper.scrollTo({
                        left: scrollLeftPosition,
                        behavior: 'auto'
                    });
                }
            });
        }
        
        function renderAll() {
            const activeNames = activityOrder.filter(name => activities[name] && !activities[name].isArchived);
            const archivedNames = Object.keys(activities).filter(name => activities[name] && activities[name].isArchived).sort();

            activitiesContainer.innerHTML = '';
            archivedList.innerHTML = '';
            
            activeNames.forEach(name => renderActivityCard(name, activities[name]));
            archivedNames.forEach(name => renderArchivedItem(name));
            
            archivedContainer.style.display = archivedNames.length > 0 ? 'block' : 'none';
            reorderBtn.style.display = activeNames.length > 1 ? 'inline-block' : 'none';

            const manageSection = document.getElementById('manage-activities-section');
            if (manageSection) {
                manageSection.open = activeNames.length === 0;
            }

            setTimeout(scrollToTodayForAllActivities, 50); 
        }

        function renderActivityCard(name, activityData) {
            const todayString = getLocalDateString(new Date());
            const timeToday = activityData.log[todayString] || 0;
            const card = document.createElement('div');
            card.className = 'card activity-card';
            card.dataset.name = name;
            const isRunning = !!timers[name];
            const currentYear = new Date().getFullYear();

            const activityYears = new Set([currentYear, parseInt(activityData.creationDate.substring(0,4))]);
            Object.keys(activityData.log).forEach(date => activityYears.add(parseInt(date.substring(0,4))));
            const sortedYears = Array.from(activityYears).sort((a,b) => b-a);
            let yearNavHTML = sortedYears.map(year => `<button class="year-btn ${year === currentYear ? 'active' : ''}" data-action="change-year" data-year="${year}">${year}</button>`).join('');
            yearNavHTML += `<button class="year-btn" data-action="scroll-to-today" style="margin-left: auto;">Today</button>`;

            card.innerHTML = `
                <div class="activity-header">
                    <h2>
                        <div class="activity-title-group">
                           <span>${name}</span>
                           <span class="goal-display">Current Goal: ${activityData.currentGoal} minutes/day</span>
                        </div>
                        <div class="timer-display-group">
                            <button class="timer-btn toggle-timer-btn ${isRunning ? 'is-running' : 'is-stopped'}" data-action="toggle-timer">${isRunning ? 'Stop' : 'Start'}</button>
                            <button class="timer-btn" data-action="reset-today" title="Reset today's time to zero">Reset</button>
                            <span class="time-display">${formatTime(timeToday)}</span>
                        </div>
                    </h2>
                    <div class="activity-controls">
                        <button class="timer-btn" data-action="toggle-list">List View</button>
                        <button class="timer-btn" data-action="toggle-stats">Show Stats</button>
                        <button class="timer-btn edit-name-btn" data-action="edit-name">Edit Name</button>
                        <button class="timer-btn edit-goal-btn" data-action="edit-goal">Edit Goal</button>
                        <button class="timer-btn" data-action="set-manual-time">Set Manual Time</button>
                        <button class="timer-btn archive-btn" data-action="archive">Archive</button>
                        <button class="timer-btn delete-btn" data-action="delete">Delete</button>
                    </div>
                </div>
                <div class="year-nav">${yearNavHTML}</div>
                <div class="graph-container">
                    <div class="graph-scroll-wrapper">
                        <div class="graph-content">
                            <div class="day-labels">
                                <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                            </div>
                            <div class="month-labels"></div>
                            <div class="tracker-grid"></div>
                        </div>
                    </div>
                    <div class="graph-legend">
                        <span class="legend-label">Less</span>
                        <div class="day color-level-1"></div>
                        <div class="day color-level-2"></div>
                        <div class="day color-level-3"></div>
                        <div class="day color-level-4"></div>
                        <span class="legend-label">More</span>
                        <div class="legend-item-wrapper" style="margin-left:8px;">
                            <div class="day is-creation-date"></div>
                            <span class="legend-overlay">Creation Date</span>
                        </div>
                        <div class="legend-item-wrapper">
                            <div class="day is-today"></div>
                            <span class="legend-overlay">Today's Date</span>
                        </div>
                        <div class="legend-item-wrapper">
                            <div class="day is-today is-creation-date"></div>
                            <span class="legend-overlay">Today & Creation Date</span>
                        </div>
                    </div>
                </div>
                <div class="historical-list-container data-container"></div>
                <div class="stats-container data-container"></div>
            `;
            activitiesContainer.appendChild(card);
            
            populateGridAndLabels(name, currentYear);
            updateDataViews(name);
            updateTodayDisplay(name);
        }

        function populateGridAndLabels(activityName, year) {
            const card = activitiesContainer.querySelector(`.card[data-name="${activityName}"]`);
            if (!card) return;
            const gridElement = card.querySelector('.tracker-grid');
            const monthsElement = card.querySelector('.month-labels');
            const activityData = activities[activityName];
            const calendarGridData = createCalendarGridDataForYear(year);

            gridElement.innerHTML = '';
            monthsElement.innerHTML = '';
            const todayString = getLocalDateString(new Date());
            const totalWeeks = Math.ceil(calendarGridData.length / 7);

            monthsElement.style.gridTemplateColumns = `repeat(${totalWeeks}, var(--day-size))`;
            gridElement.style.gridTemplateColumns = `repeat(${totalWeeks}, var(--day-size))`;

            let lastMonth = -1;
            calendarGridData.forEach((cell, index) => {
                if (cell.type === 'empty') { gridElement.appendChild(document.createElement('div')); return; }
                
                const weekIndex = Math.floor(index / 7);
                const date = cell.date;
                const month = date.getMonth();

                if (month !== lastMonth) {
                    lastMonth = month;
                    const monthLabel = document.createElement('div');
                    monthLabel.className = 'month-label';
                    monthLabel.textContent = MONTH_NAMES[lastMonth];
                    monthLabel.style.gridColumn = `${weekIndex + 1} / span 4`;
                    monthsElement.appendChild(monthLabel);
                }
                const day = document.createElement('div');
                const dateString = getLocalDateString(date);
                day.className = 'day';
                day.dataset.date = dateString;
                if (month % 2 !== 0) day.classList.add('alt-month');
                
                const totalSeconds = activityData.log[dateString] || 0;
                const goalForDay = getGoalForDate(activityData, dateString);
                day.dataset.tooltipText = `${formatTime(totalSeconds)} of ${goalForDay}m goal on ${dateString}`;
                updateGridSquare(day, totalSeconds, date, goalForDay);
                if (dateString === todayString) day.classList.add('is-today');
                if (dateString === activityData.creationDate) day.classList.add('is-creation-date');
                gridElement.appendChild(day);
            });
        }
        
        function populateStats(name) {
            const card = document.querySelector(`.card[data-name="${name}"]`);
            if (!card) return;
            const statsContainer = card.querySelector('.stats-container');
            const activityData = activities[name];

            const logEntries = Object.entries(activityData.log)
                .filter(([, time]) => time > 0)
                .sort((a, b) => new Date(a[0]) - new Date(b[0]));
            
            const totalSeconds = logEntries.reduce((sum, [, time]) => sum + time, 0);
            const totalDays = logEntries.length;

            const goalMetDates = Object.keys(activityData.log)
                .filter(dateStr => {
                    const timeInSeconds = activityData.log[dateStr] || 0;
                    const goalInMinutes = getGoalForDate(activityData, dateStr);
                    return (timeInSeconds / 60) >= goalInMinutes;
                })
                .map(dateStr => {
                    const [y, m, d] = dateStr.split('-').map(Number);
                    return new Date(y, m - 1, d);
                })
                .sort((a, b) => a - b);

            let currentStreak = 0;
            let longestStreak = 0;

            if (goalMetDates.length > 0) {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);
                
                const lastSuccessDate = goalMetDates[goalMetDates.length - 1];

                if (lastSuccessDate.getTime() === today.getTime() || lastSuccessDate.getTime() === yesterday.getTime()) {
                    currentStreak = 1;
                    for (let i = goalMetDates.length - 2; i >= 0; i--) {
                        const d1 = goalMetDates[i+1];
                        const d2 = goalMetDates[i];
                        const expectedPreviousDay = new Date(d1);
                        expectedPreviousDay.setDate(d1.getDate() - 1);
                        if (expectedPreviousDay.getTime() === d2.getTime()) {
                            currentStreak++;
                        } else {
                            break;
                        }
                    }
                }

                let currentRun = 0;
                if (goalMetDates.length > 0) {
                    currentRun = 1;
                    longestStreak = 1;
                    for (let i = 1; i < goalMetDates.length; i++) {
                        const d1 = goalMetDates[i];
                        const d2 = goalMetDates[i-1];
                        const expectedPreviousDay = new Date(d1);
                        expectedPreviousDay.setDate(d1.getDate() - 1);
                        
                        if (expectedPreviousDay.getTime() === d2.getTime()) {
                            currentRun++;
                        } else {
                            longestStreak = Math.max(longestStreak, currentRun);
                            currentRun = 1;
                        }
                    }
                    longestStreak = Math.max(longestStreak, currentRun);
                }
            }
            
            const bestDay = logEntries.reduce((best, current) => current[1] > best[1] ? current : best, ["N/A", 0]);
            
            statsContainer.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item"><strong>Total Time Logged</strong><span>${formatTime(totalSeconds)}</span></div>
                    <div class="stat-item"><strong>Total Active Days</strong><span>${totalDays}</span></div>
                    <div class="stat-item"><strong>Current Streak</strong><span>${currentStreak} days</span></div>
                    <div class="stat-item"><strong>Longest Streak</strong><span>${longestStreak} days</span></div>
                    <div class="stat-item"><strong>Best Day</strong><span>${formatTime(bestDay[1])} on ${bestDay[0]}</span></div>
                    <div class="stat-item"><strong>Average Per Day</strong><span>${formatTime(totalDays > 0 ? totalSeconds / totalDays : 0)}</span></div>
                </div>
            `;
        }
        
        function updateDataViews(name) {
            populateStats(name);
            populateListView(name);
        }

        function formatTime(seconds) { if (seconds === undefined || seconds === null) return '0m 0s'; const m = Math.floor(seconds / 60); const s = Math.floor(seconds % 60); return `${m}m ${s}s`; }
        
        function populateListView(name) {
            const card = document.querySelector(`.card[data-name="${name}"]`);
            if(!card) return;
            const listContainer = card.querySelector('.historical-list-container');
            if (!listContainer) return;

            const activityData = activities[name];
            const activityLog = activityData.log;
            const loggedEntries = Object.entries(activityLog)
                .filter(([, time]) => time > 0)
                .sort((a, b) => new Date(b[0]) - new Date(a[0]));

            listContainer.innerHTML = '';
            const list = document.createElement('ul');
            list.className = 'historical-list';
            list.innerHTML = `<li class="list-header"><span>Date</span><span>Time Spent</span><span>Daily Goal</span><span>Goal Achieved</span></li>`;

            if (loggedEntries.length === 0) {
                listContainer.innerHTML = `<p style="font-size: 13px; color: var(--text-muted-color); margin-top: 10px;">No historical activity recorded.</p>`;
                return;
            }

            loggedEntries.forEach(([date, time]) => {
                const goalForDay = getGoalForDate(activityData, date);
                const goalAchieved = (time / 60) >= goalForDay ? 'Yes' : 'No';
                const li = document.createElement('li');
                li.innerHTML = `<span>${date}</span> <span>${formatTime(time)}</span> <span>${goalForDay} minutes</span> <span>${goalAchieved}</span>`;
                list.appendChild(li);
            });
            listContainer.appendChild(list);
        }
        
        function updateGridSquare(dayElement, totalSeconds, date, goalMinutes) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            dayElement.classList.remove('color-level-1', 'color-level-2', 'color-level-3', 'color-level-4', 'goal-completed');
            
            const compareDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            if (compareDate > today) return;
            
            const totalMinutes = totalSeconds / 60;
            if (totalMinutes > 0) {
                const percentageOfGoal = goalMinutes > 0 ? (totalMinutes / goalMinutes) : 1;
                
                if (percentageOfGoal >= 1) {
                    dayElement.classList.add('color-level-4', 'goal-completed');
                } else if (percentageOfGoal >= 0.75) {
                    dayElement.classList.add('color-level-3');
                } else if (percentageOfGoal >= 0.50) {
                    dayElement.classList.add('color-level-2');
                } else if (percentageOfGoal > 0) {
                    dayElement.classList.add('color-level-1');
                }
            }
        }

        function updateTodayDisplay(activityName) { const todayString = getLocalDateString(new Date()); const activityData = activities[activityName]; if(!activityData) return; const totalSeconds = (activityData.log || {})[todayString] || 0; const timeDisplay = document.querySelector(`.card[data-name="${activityName}"] .time-display`); if (timeDisplay) timeDisplay.textContent = `Today: ${formatTime(totalSeconds)}`; const card = document.querySelector(`.card[data-name="${activityName}"]`); if (!card) return; const daySquare = card.querySelector(`.day[data-date="${todayString}"]`); if (daySquare) { const todayDateObject = new Date(); daySquare.dataset.tooltipText = `${formatTime(totalSeconds)} of ${activityData.currentGoal}m goal on ${todayString}`; updateGridSquare(daySquare, totalSeconds, todayDateObject, activityData.currentGoal); } }
        function saveState() { localStorage.setItem('multiActivityTracker', JSON.stringify({activities, activityOrder})); }
        function getGoalForDate(activityData, dateString) { const historyDates = Object.keys(activityData.goalHistory).sort().reverse(); for (const historyDate of historyDates) { if (dateString >= historyDate) { return activityData.goalHistory[historyDate]; } } return activityData.currentGoal; }
        function setAndProcessData(dataToLoad) { let loadedActivities = dataToLoad.activities || dataToLoad; let loadedOrder = dataToLoad.activityOrder || Object.keys(loadedActivities).filter(name => !loadedActivities[name].isArchived).sort(); for (const name in loadedActivities) { if (!loadedActivities[name].hasOwnProperty('goalHistory')) { const oldGoal = loadedActivities[name].goal || 15; loadedActivities[name].currentGoal = oldGoal; loadedActivities[name].goalHistory = { [loadedActivities[name].creationDate]: oldGoal }; } if (!loadedActivities[name].hasOwnProperty('isArchived')) { loadedActivities[name].isArchived = false; } if (!loadedActivities[name].hasOwnProperty('creationDate')) { loadedActivities[name].creationDate = getLocalDateString(new Date()); } } activities = loadedActivities; activityOrder = loadedOrder; saveState(); renderAll(); }
        function loadState() { const data = JSON.parse(localStorage.getItem('multiActivityTracker') || '{}'); if (Object.keys(data).length > 0) { setAndProcessData(data); } }
        function startTimer(name) { timers[name] = setInterval(() => { const todayString = getLocalDateString(new Date()); activities[name].log = activities[name].log || {}; activities[name].log[todayString] = (activities[name].log[todayString] || 0) + 1; updateTodayDisplay(name); updateDataViews(name); }, 1000); }
        function stopTimer(name) { if (timers[name]) { clearInterval(timers[name]); delete timers[name]; saveState(); } }
        
        function showModal(title, message, inputsHTML, onConfirm) {
            document.getElementById('modal-error-message').style.display = 'none';
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message;
            document.getElementById('modal-inputs').innerHTML = inputsHTML || '';
            modal.classList.add('visible');
            modalConfirmCallback = onConfirm;
        }

        function showModalError(message) {
            const errorMessageElement = document.getElementById('modal-error-message');
            errorMessageElement.textContent = message;
            errorMessageElement.style.display = 'block';
        }

        function hideModal() {
            modal.classList.remove('visible');
            document.getElementById('modal-error-message').style.display = 'none';
            modalConfirmCallback = () => {};
            const confirmBtn = modal.querySelector('[data-action="modal-confirm"]');
            const cancelBtn = modal.querySelector('[data-action="modal-cancel"]');
            confirmBtn.textContent = 'Confirm';
            cancelBtn.style.display = '';
        }

        function showInfoModal(title, message) {
            showModal(title, message, null, hideModal);
            const confirmBtn = modal.querySelector('[data-action="modal-confirm"]');
            const cancelBtn = modal.querySelector('[data-action="modal-cancel"]');
            confirmBtn.textContent = 'OK';
            cancelBtn.style.display = 'none';
        }

        docBody.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;

            const action = button.dataset.action;
            const card = e.target.closest('.activity-card, .archived-activity-item');
            const name = card ? card.dataset.name : null;

            if (action === 'toggle-theme') { docBody.classList.toggle('dark-mode'); localStorage.setItem('theme', docBody.classList.contains('dark-mode') ? 'dark' : 'light'); return; }
            if (action === 'export') { exportData(); return; }
            if (action === 'modal-cancel') { hideModal(); return; }
            if (action === 'modal-confirm') { document.getElementById('modal-error-message').style.display = 'none'; modalConfirmCallback(); return; }
            if (action === 'add-activity') { const activityName = activityNameInput.value.trim(); const goal = parseInt(activityGoalInput.value, 10) || 15; if (activityName && !activities[activityName]) { const creationDate = getLocalDateString(new Date()); activities[activityName] = { creationDate, currentGoal: goal, isArchived: false, goalHistory: { [creationDate]: goal }, log: {} }; activityOrder.push(activityName); activityNameInput.value = ''; activityGoalInput.value = 15; saveState(); renderAll(); } else if (activities[activityName]) { showInfoModal('Activity Exists', 'An activity with this name already exists.'); } return; }
            if (action === 'reorder-activities') {
                setupReorderModal();
                return;
            }

            if (!name) return;

            switch(action) {
                case 'toggle-timer': { const timerButton = card.querySelector(`[data-action="toggle-timer"]`); const isRunning = timerButton.classList.contains('is-running'); if (isRunning) { stopTimer(name); timerButton.textContent = 'Start'; } else { startTimer(name); timerButton.textContent = 'Stop'; } timerButton.classList.toggle('is-running'); timerButton.classList.toggle('is-stopped'); break; }
                case 'reset-today': { showModal('Reset Time', `Are you sure you want to reset today's time for "${name}" to zero?`, null, () => { const todayString = getLocalDateString(new Date()); if (timers[name]) { stopTimer(name); const timerButton = card.querySelector(`[data-action="toggle-timer"]`); if (timerButton) { timerButton.textContent = 'Start'; timerButton.classList.remove('is-running'); timerButton.classList.add('is-stopped'); } } activities[name].log[todayString] = 0; saveState(); renderAll(); hideModal(); }); break; }
                case 'archive': { showModal('Archive Activity', `Are you sure you want to archive "${name}"?`, null, () => { activities[name].isArchived = true; activityOrder = activityOrder.filter(item => item !== name); saveState(); renderAll(); hideModal(); }); break; }
                case 'unarchive': { activities[name].isArchived = false; activityOrder.push(name); saveState(); renderAll(); break; }
                case 'delete': { showModal('Delete Activity', `Are you sure you want to PERMANENTLY delete "${name}"? This cannot be undone.`, null, () => { if (timers[name]) stopTimer(name); delete activities[name]; activityOrder = activityOrder.filter(item => item !== name); saveState(); renderAll(); hideModal(); }); break; }
                case 'edit-name': { showModal('Edit Activity Name', '', `<div class="input-group"><input type="text" id="modal-input-name" value="${name}"></div>`, () => { const newName = document.getElementById('modal-input-name').value.trim(); if (newName && newName !== name && !activities[newName]) { Object.defineProperty(activities, newName, Object.getOwnPropertyDescriptor(activities, name)); delete activities[name]; activityOrder = activityOrder.map(item => item === name ? newName : item); saveState(); renderAll(); hideModal(); } else if (activities[newName]) { showModalError('An activity with that name already exists.'); } else { hideModal(); } }); break; }
                case 'edit-goal': { const currentGoal = activities[name].currentGoal; showModal('Edit Daily Goal', `Set a new goal for "${name}". This will apply from today onwards.`, `<div class="input-group"><input type="number" id="modal-input-goal" value="${currentGoal}" min="1"></div>`, () => { const newGoal = parseInt(document.getElementById('modal-input-goal').value, 10); if (newGoal && newGoal > 0) { const todayString = getLocalDateString(new Date()); activities[name].currentGoal = newGoal; activities[name].goalHistory[todayString] = newGoal; saveState(); renderAll(); } hideModal(); }); break; }
                case 'set-manual-time': {
                    const todayString = getLocalDateString(new Date());
                    showModal('Set Manual Time', `Set a time entry for "${name}". This will overwrite any existing time for the selected date.`, `<div class="input-group"><label>Date</label><input type="date" id="modal-input-date" value="${todayString}"></div><div class="input-group"><label>Minutes</label><input type="number" id="modal-input-minutes" min="0" placeholder="e.g., 25"></div>`, () => {
                        const date = document.getElementById('modal-input-date').value;
                        const minutes = parseInt(document.getElementById('modal-input-minutes').value, 10);
                        const creationDate = activities[name].creationDate;

                        if (!date || isNaN(minutes) || minutes < 0) {
                            showModalError('Please enter a valid date and minutes (0 or greater).');
                            return;
                        }

                        if (date < creationDate) {
                            showModalError(`Date cannot be before activity creation date (${creationDate}).`);
                            return;
                        }

                        if (date > todayString) {
                            showModalError('Cannot add entries for future dates.');
                            return;
                        }

                        const seconds = minutes * 60;
                        activities[name].log[date] = seconds;
                        saveState();
                        renderAll();
                        hideModal();
                    });
                    break;
                }
                case 'toggle-list': { const listContainer = card.querySelector('.historical-list-container'); const statsContainer = card.querySelector('.stats-container'); statsContainer.style.display = 'none'; const isListHidden = window.getComputedStyle(listContainer).display === 'none'; listContainer.style.display = isListHidden ? 'block' : 'none'; break; }
                case 'toggle-stats': { const statsContainer = card.querySelector('.stats-container'); const listContainer = card.querySelector('.historical-list-container'); listContainer.style.display = 'none'; const areStatsHidden = window.getComputedStyle(statsContainer).display === 'none'; statsContainer.style.display = areStatsHidden ? 'block' : 'none'; break; }
                case 'change-year': { card.querySelectorAll('.year-btn').forEach(btn => btn.classList.remove('active')); button.classList.add('active'); populateGridAndLabels(name, parseInt(button.dataset.year)); break; }
                case 'scroll-to-today': {
                    const currentYear = new Date().getFullYear();
                    const activeYearButton = card.querySelector('.year-btn.active');
                    
                    if (!activeYearButton || parseInt(activeYearButton.dataset.year) !== currentYear) {
                        populateGridAndLabels(name, currentYear);
                        if (activeYearButton) activeYearButton.classList.remove('active');
                        const newActiveButton = card.querySelector(`.year-btn[data-year="${currentYear}"]`);
                        if (newActiveButton) newActiveButton.classList.add('active');
                    }

                    setTimeout(() => {
                        const todayCell = card.querySelector('.day.is-today');
                        if (todayCell) {
                            const scrollWrapper = card.querySelector('.graph-scroll-wrapper');
                            const scrollLeftPosition = todayCell.offsetLeft - (scrollWrapper.offsetWidth / 2) + (todayCell.offsetWidth / 2);
                            scrollWrapper.scrollTo({
                                left: scrollLeftPosition,
                                behavior: 'smooth'
                            });
                        }
                    }, 50);
                    break;
                }
            }
        });
        
        function setupReorderModal() {
            const activeNames = activityOrder.filter(name => !activities[name].isArchived);
            const listItemsHTML = activeNames.map(name => `
                <div class="reorder-item" data-name="${name}">
                    <span>${name}</span>
                    <div class="reorder-controls">
                        <button class="reorder-btn" data-action="move-up"></button>
                        <button class="reorder-btn" data-action="move-down"></button>
                    </div>
                </div>
            `).join('');
            const modalContentHTML = `<div id="reorder-list-container">${listItemsHTML}</div>`;

            showModal('Reorder Activities', 'Use the arrows to change the order.', modalContentHTML, () => {
                const reorderListContainer = document.getElementById('reorder-list-container');
                const newOrder = [...reorderListContainer.querySelectorAll('.reorder-item')].map(item => item.dataset.name);
                activityOrder = newOrder;
                saveState();
                renderAll();
                hideModal();
            });
            
            const reorderListContainer = document.getElementById('reorder-list-container');
            updateReorderButtonStates(reorderListContainer);

            reorderListContainer.addEventListener('click', e => {
                const button = e.target.closest('button.reorder-btn');
                if (!button) return;

                const item = button.closest('.reorder-item');
                if (button.dataset.action === 'move-up') {
                    const previousItem = item.previousElementSibling;
                    if (previousItem) {
                        reorderListContainer.insertBefore(item, previousItem);
                    }
                } else if (button.dataset.action === 'move-down') {
                    const nextItem = item.nextElementSibling;
                    if (nextItem) {
                        reorderListContainer.insertBefore(nextItem, item);
                    }
                }
                updateReorderButtonStates(reorderListContainer);
            });
        }
        
        function updateReorderButtonStates(container) {
            const items = container.querySelectorAll('.reorder-item');
            items.forEach((item, index) => {
                item.querySelector('[data-action="move-up"]').disabled = (index === 0);
                item.querySelector('[data-action="move-down"]').disabled = (index === items.length - 1);
            });
        }

        function createCalendarGridDataForYear(year) {
            const gridCells = [];
            const startDate = new Date(year, 0, 1);
            const endDate = new Date(year, 11, 31);

            for (let i = 0; i < startDate.getDay(); i++) {
                gridCells.push({ type: 'empty' });
            }

            for (let d = new Date(startDate.getTime()); d <= endDate; d.setDate(d.getDate() + 1)) {
                gridCells.push({ type: 'date', date: new Date(d.getTime()) });
            }
            return gridCells;
        }

        function renderArchivedItem(name) { const item = document.createElement('div'); item.className = 'archived-activity-item'; item.dataset.name = name; item.innerHTML = `<span>${name}</span><div><button class="timer-btn unarchive-btn" data-action="unarchive">Unarchive</button><button class="timer-btn delete-btn" data-action="delete">Delete Permanently</button></div>`; archivedList.appendChild(item); }
        function exportData() { const dataStr = JSON.stringify({activities, activityOrder}, null, 2); const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = `activities-backup-${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (typeof importedData === 'object' && !Array.isArray(importedData) && importedData !== null) {
                        setAndProcessData(importedData);
                        showInfoModal('Success', 'Data imported successfully!');
                    } else {
                        throw new Error("Invalid format");
                    }
                } catch (error) {
                    console.error("Import Error:", error);
                    showInfoModal('Import Error', 'Could not import data. File may be corrupt or in the wrong format.');
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        document.getElementById('import-file').addEventListener('change', importData);

        let touchedTooltipElement = null;

        function hideTooltip() {
            tooltip.style.display = 'none';
        }

        function positionTooltip(clientX, clientY) {
            let x = clientX;
            let y = clientY;
            tooltip.style.left = `${x}px`;
            tooltip.style.top = `${y}px`;

            const tooltipRect = tooltip.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            let translateX, translateY;
            if (x + tooltipRect.width + 20 > viewportWidth) { translateX = 'calc(-100% - 10px)'; } else { translateX = '20px'; }
            if (y - tooltipRect.height - 10 < 0) { translateY = '20px'; } else { translateY = '-100%'; }
            tooltip.style.transform = `translate(${translateX}, ${translateY})`;
        }

        function showTooltip(text, clientX, clientY) {
            tooltip.textContent = text;
            tooltip.style.display = 'block';
            positionTooltip(clientX, clientY);
        }

        docBody.addEventListener('mouseover', e => {
            if (touchedTooltipElement) return;
            const dayElement = e.target.closest('.day[data-date]');
            if (dayElement) {
                tooltip.textContent = dayElement.dataset.tooltipText;
                tooltip.style.display = 'block';
            }
        });

        docBody.addEventListener('mouseout', e => {
            if (touchedTooltipElement) return;
            if (e.target.closest('.day[data-date]')) {
                hideTooltip();
            }
        });

        docBody.addEventListener('mousemove', e => {
            if (tooltip.style.display === 'block' && !touchedTooltipElement) {
                positionTooltip(e.clientX, e.clientY);
            }
        });

        docBody.addEventListener('touchstart', e => {
            const dayElement = e.target.closest('.day[data-date]');
            if (touchedTooltipElement && touchedTooltipElement === dayElement) {
                e.preventDefault();
                hideTooltip();
                touchedTooltipElement = null;
                return;
            }
            if (dayElement) {
                e.preventDefault();
                hideTooltip();
                showTooltip(dayElement.dataset.tooltipText, e.touches[0].clientX, e.touches[0].clientY);
                touchedTooltipElement = dayElement;
                return;
            }
            if (touchedTooltipElement) {
                hideTooltip();
                touchedTooltipElement = null;
            }
        }, { passive: false });
        
        docBody.addEventListener('wheel', e => {
            const scrollWrapper = e.target.closest('.graph-scroll-wrapper');
            if (scrollWrapper && Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
                e.preventDefault();
                scrollWrapper.scrollLeft += e.deltaY;
            }
        }, { passive: false });

        
        if (localStorage.getItem('theme') === 'dark') {
            docBody.classList.add('dark-mode');
        }
        loadState();
        renderAll();

        // --- START: Service Worker Logic ---
        const swInstallBtn = document.getElementById('sw-install-btn');
        const swRemoveBtn = document.getElementById('sw-remove-btn');
        const swUpdateBtn = document.getElementById('sw-update-btn');
        const swStatus = document.getElementById('sw-status');
        const swControls = document.getElementById('sw-controls');

        function updateSWButtonUI() {
            if (!('serviceWorker' in navigator)) {
                swControls.style.display = 'none';
                return;
            }
            
            if (navigator.serviceWorker.controller) {
                swStatus.textContent = 'Offline mode is enabled.';
                swInstallBtn.style.display = 'none';
                swRemoveBtn.style.display = 'inline-block';
                swUpdateBtn.style.display = 'inline-block';
            } else {
                swStatus.textContent = 'Enable offline mode to use the app without an internet connection.';
                swInstallBtn.style.display = 'inline-block';
                swRemoveBtn.style.display = 'none';
                swUpdateBtn.style.display = 'none';
            }
        }

        swInstallBtn.addEventListener('click', () => {
            swStatus.textContent = 'Enabling offline mode...';
            navigator.serviceWorker.register('./sw.js', { scope: './' })
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                    swStatus.textContent = 'Error: Could not enable offline mode.';
                });
        });

        swRemoveBtn.addEventListener('click', () => {
            navigator.serviceWorker.getRegistration().then(registration => {
                if (registration) {
                    registration.unregister().then(isUnregistered => {
                        if (isUnregistered) {
                            console.log('Service Worker unregistered');
                            swStatus.textContent = 'Offline mode disabled. Reloading...';
                            setTimeout(() => window.location.reload(), 1500);
                        } else {
                            swStatus.textContent = 'Error: Failed to disable offline mode.';
                        }
                    });
                }
            });
        });
        
        // *** MODIFIED BLOCK ***
        swUpdateBtn.addEventListener('click', () => {
            // First, check if the browser is online for instant feedback.
            if (!navigator.onLine) {
                swStatus.textContent = 'Cannot update while offline.';
                return;
            }

            if (navigator.serviceWorker.controller) {
                swStatus.textContent = 'Forcing update from network...';
                navigator.serviceWorker.controller.postMessage({ action: 'FORCE_UPDATE' });
            } else {
                swStatus.textContent = 'Cannot update. No active service worker.';
            }
        });
        
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            console.log('Controller changed. Reloading page to apply updates.');
            swStatus.textContent = 'App updated. Reloading...';
            window.location.reload();
        });

        // *** MODIFIED BLOCK ***
        navigator.serviceWorker.addEventListener('message', event => {
            if (event.data && event.data.type === 'UPDATE_COMPLETE') {
                swStatus.textContent = 'App has been updated. Reload the page to see the changes.';
                showInfoModal('Update Complete', 'The latest version of the app has been saved. Please reload the page to apply the changes.');
            } else if (event.data && event.data.type === 'UPDATE_FAILED') {
                // Listen for the new failure message from the SW.
                swStatus.textContent = 'Update failed. Please check your connection and try again.';
            }
        });

        updateSWButtonUI();
        // --- END: Service Worker Logic ---
    });
    </script>
</body>
</html>
